<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalmCore Pro V2.3.1 - Sistem Administrasi Sawit</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .no-print { @apply block; }
        @media print {
            .no-print { display: none !important; }
            main { padding: 0 !important; background: white !important; }
            .card { border: 1px solid #e2e8f0 !important; box-shadow: none !important; }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">

    <div id="app" class="min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar and Content will be injected here by JS -->
    </div>

    <script>
        // --- App Configuration & State Management ---
        const APP_ID = "palmcore-pro-v2-3-1";
        
        let state = {
            activeTab: 'dashboard',
            isSidebarOpen: false,
            showModal: null, // 'buy', 'sell', 'expense', 'capital'
            editingItem: null,
            data: JSON.parse(localStorage.getItem(APP_ID)) || {
                buy: [],
                sell: [],
                expenses: [],
                capital_history: [{ id: 1, date: new Date().toISOString().split('T')[0], amount: 150000000, note: 'Modal Awal' }]
            }
        };

        function saveState() {
            localStorage.setItem(APP_ID, JSON.stringify(state.data));
            render();
        }

        // --- Financial Calculations ---
        function calculateFinance() {
            const d = state.data;
            const totalBuy = d.buy.reduce((acc, curr) => acc + (Number(curr.total) || 0), 0);
            const totalSell = d.sell.reduce((acc, curr) => acc + (Number(curr.total) || 0), 0);
            const totalExp = d.expenses.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            const totalCapital = d.capital_history.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            
            const netProfit = totalSell - totalBuy - totalExp;
            const currentBalance = totalCapital + netProfit;

            const tonnageBuy = d.buy.reduce((acc, curr) => acc + (Number(curr.net) || 0), 0);
            const tonnageSell = d.sell.reduce((acc, curr) => acc + (Number(curr.net) || 0), 0);

            return { totalBuy, totalSell, totalExp, netProfit, tonnageBuy, tonnageSell, totalCapital, currentBalance };
        }

        // --- Actions ---
        window.switchTab = (tab) => {
            state.activeTab = tab;
            state.isSidebarOpen = false;
            render();
        };

        window.toggleSidebar = () => {
            state.isSidebarOpen = !state.isSidebarOpen;
            render();
        };

        window.openModal = (type, id = null) => {
            state.showModal = type;
            if (id && type === 'capital') {
                state.editingItem = state.data.capital_history.find(item => item.id === id);
            } else {
                state.editingItem = null;
            }
            render();
        };

        window.closeModal = () => {
            state.showModal = null;
            state.editingItem = null;
            render();
        };

        window.handleFormSubmit = (event, type) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const payload = Object.fromEntries(formData.entries());
            
            // Kalkulasi otomatis untuk beli/jual
            if (type === 'buy' || type === 'sell') {
                const net = (Number(payload.brutto) - Number(payload.tara)) * (1 - Number(payload.cut) / 100);
                payload.net = Math.round(net);
                payload.total = Math.round(net * Number(payload.price));
            }

            if (state.editingItem) {
                const collection = type === 'capital' ? 'capital_history' : type;
                state.data[collection] = state.data[collection].map(item => 
                    item.id === state.editingItem.id ? { ...payload, id: item.id } : item
                );
            } else {
                const collection = type === 'capital' ? 'capital_history' : (type === 'expense' ? 'expenses' : type);
                const newEntry = { ...payload, id: Date.now() };
                state.data[collection] = [newEntry, ...state.data[collection]];
            }

            closeModal();
            saveState();
        };

        window.deleteItem = (type, id) => {
            if (confirm("Hapus data ini secara permanen?")) {
                const collection = type === 'expense' ? 'expenses' : type;
                state.data[collection] = state.data[collection].filter(i => i.id !== id);
                saveState();
            }
        };

        window.exportCSV = (type) => {
            let rows = [];
            if (type === 'all') {
                rows = [
                    ...state.data.buy.map(i => ({ ...i, tipe: 'BELI' })),
                    ...state.data.sell.map(i => ({ ...i, tipe: 'JUAL' })),
                    ...state.data.expenses.map(i => ({ ...i, tipe: 'BIAYA' }))
                ].sort((a,b) => new Date(b.date) - new Date(a.date));
            } else {
                rows = state.data[type === 'expense' ? 'expenses' : type];
            }

            if (rows.length === 0) return alert("Tidak ada data untuk di-export");

            let csv = Object.keys(rows[0]).join(",") + "\n";
            rows.forEach(row => {
                csv += Object.values(row).map(v => `"${v}"`).join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PalmCore_${type}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        // --- Templates ---
        function render() {
            const finance = calculateFinance();
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <!-- Mobile Header -->
                <header class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-md no-print">
                    <div class="flex items-center gap-2">
                        <div class="bg-emerald-500 p-1.5 rounded-lg"><i data-lucide="trending-up" class="w-5 h-5"></i></div>
                        <h1 class="font-bold text-lg">PalmCore</h1>
                    </div>
                    <button onclick="toggleSidebar()" class="p-2 bg-slate-800 rounded-lg">
                        <i data-lucide="${state.isSidebarOpen ? 'x' : 'menu'}" class="w-5 h-5"></i>
                    </button>
                </header>

                <!-- Sidebar -->
                <aside class="fixed inset-y-0 left-0 z-40 w-72 bg-slate-900 text-white transform transition-transform duration-300 md:relative md:translate-x-0 ${state.isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}">
                    <div class="p-8 hidden md:flex items-center gap-3 border-b border-slate-800/50">
                        <div class="bg-emerald-500 p-2 rounded-xl"><i data-lucide="trending-up"></i></div>
                        <h1 class="text-2xl font-black text-emerald-400">PalmCore</h1>
                    </div>
                    <nav class="px-4 space-y-1 mt-6">
                        ${navBtn('dashboard', 'Dashboard KPI', 'layout-dashboard')}
                        ${navBtn('buy', 'Beli TBS Petani', 'shopping-cart')}
                        ${navBtn('sell', 'Jual ke PKS', 'truck')}
                        ${navBtn('expense', 'Biaya Operasional', 'wallet')}
                        ${navBtn('capital', 'Modal Kerja', 'arrow-right-left')}
                        ${navBtn('all_data', 'Semua Data', 'database')}
                        ${navBtn('reports', 'Laporan & Neraca', 'file-text')}
                    </nav>
                    <div class="absolute bottom-8 left-0 w-full px-6">
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-2xl border border-slate-700">
                            <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Saldo Kas Aktif</p>
                            <p class="text-xl font-bold text-emerald-400">Rp ${finance.currentBalance.toLocaleString()}</p>
                        </div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 h-screen overflow-y-auto p-4 md:p-10 pb-28 md:pb-10">
                    <div class="max-w-7xl mx-auto">
                        <div class="mb-8 no-print">
                            <h2 class="text-2xl md:text-3xl font-black text-slate-900 uppercase">${state.activeTab.replace('_', ' ')}</h2>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">Sistem Administrasi Sawit Pro</p>
                        </div>

                        ${renderView(finance)}
                    </div>
                </main>

                <!-- Modals -->
                ${state.showModal ? renderModal() : ''}

                <!-- Mobile Navigation -->
                <div class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t flex justify-around p-3 z-40 no-print">
                    ${mobileNavBtn('dashboard', 'layout-dashboard')}
                    ${mobileNavBtn('buy', 'shopping-cart')}
                    ${mobileNavBtn('sell', 'truck')}
                    ${mobileNavBtn('capital', 'arrow-right-left')}
                </div>
            `;
            lucide.createIcons();
        }

        function navBtn(id, label, icon) {
            const active = state.activeTab === id;
            return `
                <button onclick="switchTab('${id}')" class="flex items-center gap-3 w-full p-4 rounded-xl transition-all ${active ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}">
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                    <span class="font-medium text-sm">${label}</span>
                </button>
            `;
        }

        function mobileNavBtn(id, icon) {
            const active = state.activeTab === id;
            return `
                <button onclick="switchTab('${id}')" class="p-3 rounded-2xl transition-all ${active ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400'}">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                </button>
            `;
        }

        function renderView(finance) {
            switch(state.activeTab) {
                case 'dashboard': return dashboardView(finance);
                case 'buy': return tableView('buy', 'Pembelian TBS Petani', state.data.buy);
                case 'sell': return tableView('sell', 'Penjualan Ke PKS', state.data.sell);
                case 'expense': return expenseView(state.data.expenses);
                case 'capital': return capitalView(state.data.capital_history);
                case 'all_data': return allDataView();
                case 'reports': return reportView(finance);
                default: return '';
            }
        }

        function dashboardView(f) {
            return `
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    ${statCard('Total Belanja', f.totalBuy, 'shopping-cart', 'text-rose-600', 'bg-rose-100')}
                    ${statCard('Total Jual', f.totalSell, 'truck', 'text-emerald-600', 'bg-emerald-100')}
                    ${statCard('Biaya Ops', f.totalExp, 'wallet', 'text-amber-600', 'bg-amber-100')}
                    ${statCard('Profit', f.netProfit, 'dollar-sign', 'text-blue-600', 'bg-blue-100')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                        <h3 class="font-black flex items-center gap-2 mb-6 uppercase tracking-tighter"><i data-lucide="history" class="text-emerald-500"></i> Transaksi Terakhir</h3>
                        <div class="space-y-3">
                            ${[...state.data.buy, ...state.data.sell].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5).map(t => `
                                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-xl flex items-center justify-center font-black text-xs ${t.farmer ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600'}">${t.farmer ? 'IN' : 'OUT'}</div>
                                        <div>
                                            <p class="font-bold text-slate-800 leading-tight">${t.farmer || t.pks}</p>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase">${t.date} â€¢ ${t.net} KG</p>
                                        </div>
                                    </div>
                                    <p class="font-black ${t.farmer ? 'text-rose-600' : 'text-emerald-600'}">Rp ${Number(t.total).toLocaleString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-slate-900 text-white p-8 rounded-[2.5rem] flex flex-col justify-center shadow-xl">
                        <p class="text-slate-400 text-xs font-black uppercase tracking-widest mb-2">Kas Bersih Saat Ini</p>
                        <h2 class="text-4xl font-black text-emerald-400 tracking-tighter">Rp ${f.currentBalance.toLocaleString()}</h2>
                        <div class="mt-6 flex gap-2">
                            <span class="bg-emerald-500/20 px-3 py-1 rounded-full text-emerald-400 text-[10px] font-black uppercase tracking-widest">Realtime Balance</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function statCard(title, val, icon, color, bg) {
            return `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                    <div class="${bg} p-2 rounded-xl inline-block mb-3"><i data-lucide="${icon}" class="${color} w-5 h-5"></i></div>
                    <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest">${title}</p>
                    <h3 class="text-xl font-bold text-slate-900">Rp ${val.toLocaleString()}</h3>
                </div>
            `;
        }

        function tableView(type, label, data) {
            return `
                <div class="flex justify-between items-center mb-4 no-print">
                    <h3 class="text-xl font-black text-slate-800 uppercase">${label}</h3>
                    <div class="flex gap-2">
                        <button onclick="exportCSV('${type}')" class="p-3 bg-white border border-slate-200 rounded-xl text-slate-600 shadow-sm hover:bg-slate-50"><i data-lucide="download"></i></button>
                        <button onclick="openModal('${type}')" class="px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg ${type === 'buy' ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white'}"><i data-lucide="plus"></i> Tambah</button>
                    </div>
                </div>
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[800px]">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Tanggal</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">${type === 'buy' ? 'Petani' : 'PKS'}</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Netto (Kg)</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Harga</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${data.map(item => `
                                <tr>
                                    <td class="p-5 text-sm font-bold text-slate-500">${item.date}</td>
                                    <td class="p-5 font-black text-slate-800">${item.farmer || item.pks}</td>
                                    <td class="p-5 text-center font-bold text-slate-700">${Number(item.net).toLocaleString()}</td>
                                    <td class="p-5 font-black ${type === 'buy' ? 'text-rose-600' : 'text-emerald-600'}">Rp ${Number(item.total).toLocaleString()}</td>
                                    <td class="p-5 text-right no-print">
                                        <button onclick="window.print()" class="p-2 text-slate-300 hover:text-emerald-600"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                        <button onclick="deleteItem('${type}', ${item.id})" class="p-2 text-slate-300 hover:text-rose-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function capitalView(data) {
            return `
                <div class="flex justify-between items-center mb-4 no-print">
                    <h3 class="text-xl font-black text-slate-800 uppercase">Modal Kerja</h3>
                    <button onclick="openModal('capital')" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg"><i data-lucide="plus"></i> Tambah Modal</button>
                </div>
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Tanggal</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Keterangan</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Jumlah</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${data.map(c => `
                                <tr>
                                    <td class="p-5 text-sm font-bold text-slate-500">${c.date}</td>
                                    <td class="p-5 font-black text-slate-800 uppercase text-xs">${c.note}</td>
                                    <td class="p-5 font-black ${Number(c.amount) >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${Number(c.amount) >= 0 ? '+' : ''} Rp ${Number(c.amount).toLocaleString()}</td>
                                    <td class="p-5 text-right no-print">
                                        <button onclick="openModal('capital', ${c.id})" class="p-2 text-slate-300 hover:text-blue-500"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function expenseView(data) {
            return `
                <div class="flex justify-between items-center mb-4 no-print">
                    <h3 class="text-xl font-black text-slate-800 uppercase">Biaya Operasional</h3>
                    <button onclick="openModal('expense')" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg"><i data-lucide="plus"></i> Catat Biaya</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${data.map(exp => `
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex justify-between items-center group relative overflow-hidden">
                            <div class="flex items-center gap-4">
                                <div class="p-4 bg-amber-50 rounded-2xl text-amber-600 font-black text-xs uppercase">${exp.type.substring(0,3)}</div>
                                <div>
                                    <p class="font-bold text-slate-800 leading-tight">${exp.note}</p>
                                    <p class="text-[10px] text-slate-400 uppercase font-black mt-1">${exp.date}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-rose-500">- ${Number(exp.amount).toLocaleString()}</p>
                                <div class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity no-print">
                                    <button onclick="deleteItem('expense', ${exp.id})" class="text-rose-400 hover:text-rose-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function allDataView() {
            const combined = [
                ...state.data.buy.map(i => ({ ...i, category: 'BELI', color: 'text-rose-600' })),
                ...state.data.sell.map(i => ({ ...i, category: 'JUAL', color: 'text-emerald-600' })),
                ...state.data.expenses.map(i => ({ ...i, category: 'BIAYA', color: 'text-amber-600', total: Number(i.amount) }))
            ].sort((a,b) => new Date(b.date) - new Date(a.date));

            return `
                <div class="flex justify-between items-center mb-4 no-print">
                    <h3 class="text-xl font-black text-slate-800 uppercase">Arsip Semua Data</h3>
                    <button onclick="exportCSV('all')" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-slate-800 transition-all"><i data-lucide="download"></i> Export Excel</button>
                </div>
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[700px]">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Tgl</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Kategori</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Keterangan</th>
                                <th class="p-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">Nilai</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${combined.map(item => `
                                <tr>
                                    <td class="p-5 text-sm font-bold text-slate-500">${item.date}</td>
                                    <td class="p-5"><span class="text-[10px] font-black px-3 py-1 rounded-full bg-slate-100 ${item.color}">${item.category}</span></td>
                                    <td class="p-5 font-bold text-slate-800 uppercase text-xs">${item.farmer || item.pks || item.note}</td>
                                    <td class="p-5 font-black ${item.color}">Rp ${Number(item.total).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function reportView(f) {
            return `
                <div class="max-w-2xl mx-auto py-4">
                    <div class="bg-white p-12 rounded-[3rem] border border-slate-100 shadow-xl relative">
                        <div class="flex justify-between items-start border-b-2 border-slate-50 pb-10 mb-10">
                            <div>
                                <h3 class="text-3xl font-black text-slate-900 uppercase tracking-tighter">Laporan Laba Rugi</h3>
                                <p class="text-slate-400 font-black mt-1 text-[10px] uppercase tracking-widest">Sistem PalmCore Enterprise</p>
                            </div>
                            <div class="bg-emerald-500 p-2 rounded-xl"><i data-lucide="trending-up" class="text-white"></i></div>
                        </div>
                        <div class="space-y-6">
                            <div class="flex justify-between"><span>Total Penjualan</span><span class="font-black text-lg">Rp ${f.totalSell.toLocaleString()}</span></div>
                            <div class="flex justify-between"><span>Total Belanja</span><span class="font-black text-lg text-rose-500">- Rp ${f.totalBuy.toLocaleString()}</span></div>
                            <div class="flex justify-between border-b pb-4"><span>Total Biaya Operasi</span><span class="font-black text-lg text-rose-500">- Rp ${f.totalExp.toLocaleString()}</span></div>
                            <div class="bg-slate-900 p-8 rounded-[2rem] text-white mt-10 flex justify-between items-end">
                                <div>
                                    <span class="text-[10px] font-black text-slate-500 uppercase block mb-1">Laba Bersih</span>
                                    <span class="text-4xl font-black text-emerald-400">Rp ${f.netProfit.toLocaleString()}</span>
                                </div>
                                <div class="bg-emerald-500/20 text-emerald-400 px-4 py-2 rounded-2xl font-black text-xs">${((f.netProfit / (f.totalSell || 1)) * 100).toFixed(1)}% Margin</div>
                            </div>
                        </div>
                        <div class="mt-10 flex gap-4 no-print">
                            <button onclick="window.print()" class="flex-1 bg-slate-900 text-white p-5 rounded-2xl font-black text-xs uppercase hover:bg-emerald-600 transition-all"><i data-lucide="printer" class="inline w-4 h-4 mr-2"></i> Cetak Laporan</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModal() {
            const isEditing = !!state.editingItem;
            return `
                <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden animate-in zoom-in-95">
                        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                            <h3 class="font-black text-xl text-slate-800 uppercase tracking-tight">${isEditing ? 'Edit Data' : 'Tambah Data'}</h3>
                            <button onclick="closeModal()" class="p-2 hover:bg-slate-200 rounded-full"><i data-lucide="x"></i></button>
                        </div>
                        <div class="p-6 max-h-[80vh] overflow-y-auto">
                            <form onsubmit="handleFormSubmit(event, '${state.showModal}')" class="space-y-4">
                                ${renderFormFields()}
                                <button type="submit" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-black mt-4 shadow-xl uppercase tracking-widest hover:bg-emerald-500 transition-all">
                                    ${isEditing ? 'Update Data' : 'Simpan Data'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFormFields() {
            const i = state.editingItem || {};
            const commonDate = `<div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Tanggal</label><input name="date" type="date" value="${i.date || new Date().toISOString().split('T')[0]}" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none" required></div>`;
            
            if (state.showModal === 'buy') {
                return commonDate + `
                    <input name="farmer" placeholder="Nama Petani" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    <div class="grid grid-cols-2 gap-4">
                        <input name="brutto" type="number" placeholder="Brutto (Kg)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                        <input name="tara" type="number" placeholder="Tara (Kg)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input name="cut" type="number" placeholder="Pot (%)" value="3" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                        <input name="price" type="number" placeholder="Harga/Kg" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    </div>`;
            } else if (state.showModal === 'sell') {
                return commonDate + `
                    <input name="pks" placeholder="Nama PKS" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    <div class="grid grid-cols-2 gap-4">
                        <input name="brutto" type="number" placeholder="Brutto (Kg)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                        <input name="tara" type="number" placeholder="Tara (Kg)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input name="cut" type="number" placeholder="Pot (%)" value="1" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                        <input name="price" type="number" placeholder="Harga/Kg" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    </div>`;
            } else if (state.showModal === 'expense') {
                return commonDate + `
                    <select name="type" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none">
                        <option value="BBM">BBM</option><option value="Gaji">Gaji</option><option value="Operasional">Operasional</option><option value="Lainnya">Lainnya</option>
                    </select>
                    <input name="note" placeholder="Keterangan Biaya" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    <input name="amount" type="number" placeholder="Jumlah Rp" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>`;
            } else if (state.showModal === 'capital') {
                return commonDate + `
                    <input name="note" value="${i.note || ''}" placeholder="Keterangan (e.g. Suntikan Dana)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>
                    <input name="amount" type="number" value="${i.amount || ''}" placeholder="Jumlah Rp (Gunakan - untuk tarik)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold" required>`;
            }
        }

        // Initialize App
        render();
    </script>
</body>
</html>

